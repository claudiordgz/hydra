// Generated by CoffeeScript 1.9.3
(function() {
  var nextPost, util;

  util = require("../common/util");

  nextPost = function() {
    var $nextPostContainer, currentUrl, isNext, page, result, timeout;
    if ($('.next-post').length) {
      page = 0;
      isNext = false;
      result = new Array;
      $nextPostContainer = $('.next-post');
      currentUrl = $nextPostContainer.data('current-url');
      if (currentUrl !== '') {
        timeout = setInterval((function() {
          var ajaxUrl;
          page = page + 1;
          ajaxUrl = sfThemeOptions.global.rootUrl + '/rss/' + page + '/';
          if (page === 1) {
            ajaxUrl = sfThemeOptions.global.rootUrl + '/rss/';
          }
          $.ajax({
            type: 'GET',
            url: ajaxUrl,
            dataType: 'xml',
            success: function(xml) {
              if ($(xml).length) {
                $('item', xml).each(function() {
                  var regResult;
                  var regExp;
                  var $backgroundEl, $desc, $iframeEl, $videoEl, $vimeoVideoEl, frameSrc, htmlStr, itemUrl, regExp, regResult, videoUrl, vimeoId, vimeoUrl, vimeoVideoUrl, youtubeId;
                  itemUrl = $(this).find('link').eq(0).text();
                  if (isNext) {
                    result['link'] = itemUrl;
                    result['title'] = $(this).find('title').eq(0).text();
                    result['pubDate'] = util.formatDate(new Date($(this).find('pubDate').eq(0).text()));
                    $desc = $(this).find('description');
                    console.log($desc);
                    $desc = $desc.eq(0).text();
                    $desc = $($desc);
                    if ($desc.first().is('iframe')) {
                      $iframeEl = $desc.first();
                      frameSrc = $desc.first().attr('src');
                      if (frameSrc.indexOf('youtube.com') >= 0) {
                        regExp = /youtube(-nocookie)?\.com\/(embed|v)\/([\w_-]+)/;
                        youtubeId = '';
                        regResult = frameSrc.match(regExp);
                        if (regResult[3] !== 'undefined' && regResult[3] !== '') {
                          result['background'] = 'http://i3.ytimg.com/vi/' + regResult[3] + '/0.jpg';
                          result['cssClass'] = 'video-post';
                        }
                      } else if (frameSrc.indexOf('vimeo.com') >= 0) {
                        regExp = /video\/(\d+)/;
                        regResult = frameSrc.match(regExp);
                        if (regResult[1] !== 'undefined' && regResult[1] !== '') {
                          vimeoUrl = 'http://vimeo.com/api/v2/video/' + regResult[1] + '.json';
                          console.log(vimeoUrl);
                          $.ajax({
                            type: 'GET',
                            url: vimeoUrl,
                            dataType: 'json',
                            success: function(vimeoResult) {
                              var vimeoUrl;
                              var regResult;
                              var regExp;
                              var youtubeId;
                              var htmlStr;
                              if (vimeoResult.length) {
                                $nextPostContainer.css('background-image', 'url("' + vimeoResult[0].thumbnail_large + '")');
                                $nextPostContainer.addClass('video-post');
                                htmlStr = '<div class="next-post-wrap">                                                                                <div class="next-label">Next Story</div>                                                                                <h2 class="post-title"><a href="' + result['link'] + '">' + result['title'] + '</a></h2>                                                                                <div class="post-meta">' + result['pubDate'] + '</div>                                                                                <div class="next-arrow"><a href="' + result['link'] + '"><i class="fa fa-angle-double-down"></i></a></div>                                                                            </div>';
                                $nextPostContainer.html(htmlStr);
                              }
                            }
                          });
                        }
                      }
                    } else if ($desc.has('img[alt*="image-post"]').length) {
                      $backgroundEl = $desc.find('img[alt*="image-post"]');
                      if ($backgroundEl.length) {
                        result['cssClass'] = $backgroundEl.attr('alt');
                        result['background'] = $backgroundEl.attr('src');
                      }
                    } else if ($desc.has('a[href*="youtube.com"]').length) {
                      $videoEl = $desc.find('a[href*="youtube.com"]');
                      if ($videoEl.length) {
                        videoUrl = $videoEl.attr('href');
                        if (videoUrl !== '') {
                          youtubeId = videoUrl.match(/[\\?&]v=([^&#]*)/)[1];
                          if (youtubeId !== '') {
                            result['background'] = 'http://i3.ytimg.com/vi/' + youtubeId + '/0.jpg';
                            result['cssClass'] = 'video-post';
                          }
                        }
                      }
                    } else if ($desc.has('a[href*="vimeo.com"]').length) {
                      $vimeoVideoEl = $desc.find('a[href*="vimeo.com"]');
                      vimeoVideoUrl = $vimeoVideoEl.attr('href');
                      regExp = /vimeo.com\/(\d+)/;
                      vimeoId = '';
                      regResult = vimeoVideoUrl.match(regExp);
                      if (regResult[1] !== 'undefined' && regResult[1] !== '') {
                        vimeoUrl = 'http://vimeo.com/api/v2/video/' + regResult[1] + '.json';
                        $.ajax({
                          type: 'GET',
                          url: vimeoUrl,
                          dataType: 'json',
                          success: function(vimeoResult) {
                            var htmlStr;
                            if (vimeoResult.length && vimeoResult[0].thumbnail_large !== '') {
                              $nextPostContainer.css('background-image', 'url("' + vimeoResult[0].thumbnail_large + '")');
                              $nextPostContainer.addClass('video-post');
                              htmlStr = '<div class="next-post-wrap">                                                                            <div class="next-label">Next Story</div>                                                                            <h2 class="post-title"><a href="' + result['link'] + '">' + result['title'] + '</a></h2>                                                                            <div class="post-meta">' + result['pubDate'] + '</div>                                                                            <div class="next-arrow"><a href="' + result['link'] + '"><i class="fa fa-angle-double-down"></i></a></div>                                                                        </div>';
                              $nextPostContainer.html(htmlStr);
                            }
                          }
                        });
                      }
                    }
                    if (result['link'] !== void 0) {
                      if (result['background'] !== void 0 && result['background'] !== '') {
                        $nextPostContainer.css('background-image', 'url("' + result['background'] + '")');
                      }
                      if (result['cssClass'] !== void 0 && result['cssClass'] !== '') {
                        $nextPostContainer.addClass(result['cssClass']);
                      }
                      htmlStr = '<div class="next-post-wrap">                                                            <div class="next-label">Next Story</div>                                                            <h2 class="post-title"><a href="' + result['link'] + '">' + result['title'] + '</a></h2>                                                            <div class="post-meta">' + result['pubDate'] + '</div>                                                            <div class="next-arrow"><a href="' + result['link'] + '"><i class="fa fa-angle-double-down"></i></a></div>                                                        </div>';
                      $nextPostContainer.html(htmlStr);
                    }
                    clearInterval(timeout);
                    return false;
                  } else if (currentUrl === itemUrl) {
                    isNext = true;
                  }
                });
              }
            }
          });
        }), 2000);
      }
    }
  };

  module.exports = {
    nextPost: nextPost
  };

}).call(this);
